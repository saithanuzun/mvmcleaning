@model mvmclean.backend.WebApp.Areas.Admin.Models.CreateBookingFormModel

@{
    ViewData["Title"] = "Create Booking";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-1">
                <i class="bi bi-plus-circle"></i> Create New Booking
            </h2>
            <p class="text-muted mb-0">Manually create a booking for a customer</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/Admin/Booking/AllBookings" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Bookings
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form id="createBookingForm" method="post" action="/Admin/Booking/Create">
        
        <div class="row">
            <!-- Customer Information -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person"></i> Customer Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="CustomerName" class="form-label">Customer Name *</label>
                            <input id="CustomerName" name="CustomerName" type="text" class="form-control" placeholder="e.g., John Smith" value="@Model?.CustomerName" required />
                            <span class="text-danger" id="CustomerNameError"></span>
                        </div>

                        <div class="mb-3">
                            <label for="CustomerEmail" class="form-label">Email Address *</label>
                            <input id="CustomerEmail" name="CustomerEmail" type="email" class="form-control" placeholder="customer@example.com" value="@Model?.CustomerEmail" required />
                            <span class="text-danger" id="CustomerEmailError"></span>
                        </div>

                        <div class="mb-3">
                            <label for="CustomerPhone" class="form-label">Phone Number *</label>
                            <input id="CustomerPhone" name="CustomerPhone" type="tel" class="form-control" placeholder="07900123456" value="@Model?.CustomerPhone" required />
                            <span class="text-danger" id="CustomerPhoneError"></span>
                        </div>

                        <div class="mb-3">
                            <label for="Address" class="form-label">Street Address *</label>
                            <input id="Address" name="Address" type="text" class="form-control" placeholder="e.g., 10 Downing Street" value="@Model?.Address" required />
                            <span class="text-danger" id="AddressError"></span>
                        </div>

                        <div class="mb-3">
                            <label for="Postcode" class="form-label">Postcode *</label>
                            <input id="Postcode" name="Postcode" type="text" class="form-control" placeholder="e.g., SW1A 2AA" value="@Model?.Postcode" required />
                            <span class="text-danger" id="PostcodeError"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scheduling & Contractor -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Scheduling & Contractor</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="ScheduledDate" class="form-label">Scheduled Date *</label>
                            <input id="ScheduledDate" name="ScheduledDate" type="date" class="form-control" value="@Model?.ScheduledDate" required />
                            <span class="text-danger" id="ScheduledDateError"></span>
                        </div>

                        <div class="mb-3">
                            <label for="ScheduledTime" class="form-label">Scheduled Time *</label>
                            <input id="ScheduledTime" name="ScheduledTime" type="time" class="form-control" value="@Model?.ScheduledTime" required />
                            <span class="text-danger" id="ScheduledTimeError"></span>
                        </div>

                        <div class="mb-3">
                            <label for="DurationMinutes" class="form-label">Duration (Minutes) *</label>
                            <input id="DurationMinutes" name="DurationMinutes" type="number" class="form-control" value="@(Model?.DurationMinutes ?? 60)" min="15" step="15" required />
                            <span class="text-danger" id="DurationMinutesError"></span>
                        </div>

                        <div class="mb-3">
                            <label for="ContractorId" class="form-label">Select Contractor *</label>
                            <div class="input-group">
                                <select id="ContractorId" name="ContractorId" class="form-select" required>
                                    <option value="">-- Select a Contractor --</option>
                                    @if (ViewBag.Contractors != null)
                                    {
                                        @foreach (var contractor in ViewBag.Contractors)
                                        {
                                            <option value="@contractor.Id">
                                                @contractor.FullName (@(contractor.IsActive ? "Active" : "Inactive"))
                                            </option>
                                        }
                                    }
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#activateModal" id="activateContractorBtn" title="Activate selected contractor">
                                    <i class="bi bi-check-circle"></i> Activate
                                </button>
                            </div>
                            <span class="text-danger" id="ContractorIdError"></span>
                            <small class="form-text text-muted d-block mt-2">Can't find your contractor? Activate them from the dropdown above.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services Selection -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-basket"></i> Services</h5>
            </div>
            <div class="card-body">
                <div id="servicesContainer" class="row g-3">
                    <div class="col-12">
                        <p class="text-muted">Select services to add to this booking.</p>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#serviceModal">
                        <i class="bi bi-plus"></i> Add Service
                    </button>
                </div>

                <div id="selectedServices" class="mt-4">
                    <h6>Selected Services:</h6>
                    <div id="selectedServicesList" class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Service Name</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No services selected</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-3 row">
                    <div class="col-md-6">
                        <label for="TotalAmount" class="form-label fw-bold">Total Amount *</label>
                        <input id="TotalAmount" name="TotalAmount" type="number" class="form-control" step="0.01" min="0" placeholder="0.00" value="@(Model?.TotalAmount ?? 0)" required readonly />
                        <span class="text-danger" id="TotalAmountError"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden fields for service items -->
        <div id="serviceItemsContainer"></div>

        <!-- Form Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                    <i class="bi bi-check-circle"></i> Create Booking
                </button>
                <a href="/Admin/Booking/AllBookings" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Service Selection Modal -->
<div class="modal fade" id="serviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Select Services</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="servicesList" class="row g-3">
                    @if (ViewBag.Services != null)
                    {
                        @foreach (var service in ViewBag.Services)
                        {
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">@service.Name</h6>
                                        <p class="card-text small text-muted">@service.Description</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-bold text-primary">£@service.BasePrice</span>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addService('@service.ServiceId', '@service.Name', @service.BasePrice)">
                                                <i class="bi bi-plus"></i> Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activate Contractor Modal -->
<div class="modal fade" id="activateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Activate Contractor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to activate this contractor?</p>
                <p class="text-muted small">Once activated, they will be available for new bookings.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="/Admin/Booking/ActivateContractor" style="display:inline;">
                    <input type="hidden" name="contractorId" id="contractorIdInput" />
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Activate
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let selectedServices = [];

function addService(serviceId, serviceName, price) {
    if (selectedServices.find(s => s.id === serviceId)) {
        alert('Service already added');
        return;
    }

    const service = {
        id: serviceId,
        name: serviceName,
        price: parseFloat(price),
        quantity: 1
    };

    selectedServices.push(service);
    updateServicesList();
    updateTotalAmount();

    const modal = bootstrap.Modal.getInstance(document.getElementById('serviceModal'));
    if (modal) {
        modal.hide();
    }
}

function removeService(serviceId) {
    selectedServices = selectedServices.filter(s => s.id !== serviceId);
    updateServicesList();
    updateTotalAmount();
}

function updateQuantity(serviceId, quantity) {
    const service = selectedServices.find(s => s.id === serviceId);
    if (service) {
        service.quantity = Math.max(1, parseInt(quantity) || 1);
        updateServicesList();
        updateTotalAmount();
    }
}

function updateServicesList() {
    const tbody = document.getElementById('servicesTableBody');
    const container = document.getElementById('serviceItemsContainer');

    if (selectedServices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No services selected</td></tr>';
        container.innerHTML = '';
        return;
    }

    tbody.innerHTML = selectedServices.map(service => {
        const total = (service.price * service.quantity).toFixed(2);
        const price = service.price.toFixed(2);
        return '<tr>' +
            '<td>' + service.name + '</td>' +
            '<td><input type="number" min="1" value="' + service.quantity + '" class="form-control form-control-sm" style="width: 80px;" onchange="updateQuantity(' + "'" + service.id + "'" + ', this.value)"></td>' +
            '<td>£' + price + '</td>' +
            '<td>£' + total + '</td>' +
            '<td><button type="button" class="btn btn-sm btn-danger" onclick="removeService(' + "'" + service.id + "'" + ')"><i class="bi bi-trash"></i></button></td>' +
            '</tr>';
    }).join('');

    container.innerHTML = selectedServices.map(service => {
        return '<input type="hidden" name="ServiceIds" value="' + service.id + '">' +
            '<input type="hidden" name="ServiceNames" value="' + service.name + '">' +
            '<input type="hidden" name="ServicePrices" value="' + service.price.toFixed(2) + '">' +
            '<input type="hidden" name="ServiceQuantities" value="' + service.quantity + '">';
    }).join('');
}

function updateTotalAmount() {
    const total = selectedServices.reduce((sum, service) => sum + (service.price * service.quantity), 0);
    document.getElementById('TotalAmount').value = total.toFixed(2);
}

document.getElementById('createBookingForm').addEventListener('submit', function(e) {
    let isValid = true;
    
    document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
    
    const customerName = document.getElementById('CustomerName').value.trim();
    if (!customerName) {
        document.getElementById('CustomerNameError').textContent = 'Customer name is required';
        isValid = false;
    }
    
    const customerEmail = document.getElementById('CustomerEmail').value.trim();
    if (!customerEmail) {
        document.getElementById('CustomerEmailError').textContent = 'Email is required';
        isValid = false;
    } else if (customerEmail.indexOf(String.fromCharCode(64)) === -1) {
        document.getElementById('CustomerEmailError').textContent = 'Invalid email format';
        isValid = false;
    }
    
    const customerPhone = document.getElementById('CustomerPhone').value.trim();
    if (!customerPhone) {
        document.getElementById('CustomerPhoneError').textContent = 'Phone number is required';
        isValid = false;
    }
    
    const address = document.getElementById('Address').value.trim();
    if (!address) {
        document.getElementById('AddressError').textContent = 'Address is required';
        isValid = false;
    }
    
    const postcode = document.getElementById('Postcode').value.trim();
    if (!postcode) {
        document.getElementById('PostcodeError').textContent = 'Postcode is required';
        isValid = false;
    }
    
    const contractorId = document.getElementById('ContractorId').value;
    if (!contractorId) {
        document.getElementById('ContractorIdError').textContent = 'Please select a contractor';
        isValid = false;
    }
    
    const scheduledDate = document.getElementById('ScheduledDate').value;
    if (!scheduledDate) {
        document.getElementById('ScheduledDateError').textContent = 'Date is required';
        isValid = false;
    }
    
    const scheduledTime = document.getElementById('ScheduledTime').value;
    if (!scheduledTime) {
        document.getElementById('ScheduledTimeError').textContent = 'Time is required';
        isValid = false;
    }
    
    if (selectedServices.length === 0) {
        alert('Please select at least one service');
        isValid = false;
    }
    
    if (!isValid) {
        e.preventDefault();
        return false;
    }
});

document.getElementById('activateContractorBtn').addEventListener('click', function() {
    const contractorId = document.getElementById('ContractorId').value;
    if (!contractorId) {
        alert('Please select a contractor first');
        return;
    }
    document.getElementById('contractorIdInput').value = contractorId;
});

window.addEventListener('load', function() {
    const dateInput = document.getElementById('ScheduledDate');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);
    }
});
</script>
